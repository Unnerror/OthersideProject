-- Create the stored procedure
CREATE PROCEDURE CalculateReservationPrice
    @RoomID CHAR(10),
    @ReservationStartTime DATETIME,
    @ReservationEndTime DATETIME,
    @TotalPrice DECIMAL(10, 2) OUTPUT -- Output parameter for total price
AS
BEGIN
    -- Calculate the total price for the entire reservation
    SET @TotalPrice = 0; -- Initialize total price

    -- Iterate over each hour of the reservation
    DECLARE @CurrentHour DATETIME = @ReservationStartTime;

    WHILE @CurrentHour < @ReservationEndTime
    BEGIN
        -- Get the applicable booking rule for the current hour
        DECLARE @PricePerHour DECIMAL(10, 2) = (
            SELECT TOP 1 PricePerHour
            FROM BookingRules
            WHERE RoomID = @RoomID
                AND DayOfWeek = DATENAME(WEEKDAY, @CurrentHour)
                AND CAST(StartTime AS TIME) <= CAST(@CurrentHour AS TIME)
                AND CAST(EndTime AS TIME) > CAST(@CurrentHour AS TIME)
            ORDER BY StartTime
        );

        -- Add the price for the current hour to the total price
        SET @TotalPrice = @TotalPrice + @PricePerHour;

        -- Move to the next hour
        SET @CurrentHour = DATEADD(HOUR, 1, @CurrentHour);
    END;
END;
