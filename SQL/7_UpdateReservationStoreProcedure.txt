CREATE PROCEDURE UpdateReservation
    @ReservationID INT,
    @NewStartTime DATETIME = NULL,
    @NewEndTime DATETIME = NULL,
    @NewAdminComment CHAR(512) = NULL,
    @NewForeheadVisitTime DATETIME = NULL,
    @NewNumberGuest INT = NULL
AS
BEGIN
    DECLARE @TotalPrice DECIMAL(10, 2);

    -- Calculate the total price for the updated reservation if the time slot is changing
    IF @NewStartTime IS NOT NULL AND @NewEndTime IS NOT NULL
    BEGIN
        -- Check if the room is available for the new time slot
        IF NOT EXISTS (
            SELECT 1
            FROM Reservation
            WHERE RoomID = (SELECT RoomID FROM Reservation WHERE ReservationID = @ReservationID)
                AND StartTime < @NewEndTime
                AND EndTime > @NewStartTime
                AND ReservationID != @ReservationID
        )
        BEGIN
            -- Retrieve the existing reservation details
            DECLARE @RoomID CHAR(10);

            SELECT @RoomID = RoomID
            FROM Reservation
            WHERE ReservationID = @ReservationID;

            -- Calculate the total price for the updated reservation
            EXEC CalculateReservationPrice @RoomID, @NewStartTime, @NewEndTime, @TotalPrice OUTPUT;
        END
        ELSE
        BEGIN
            PRINT 'The new time slot is not available. Reservation update failed.';
            RETURN;
        END;
    END;

    -- Update the reservation data in the Reservation table
    BEGIN TRY
        UPDATE Reservation
        SET StartTime = ISNULL(@NewStartTime, StartTime),
            EndTime = ISNULL(@NewEndTime, EndTime),
            AdminComment = ISNULL(@NewAdminComment, AdminComment),
            ForeheadVisitTime = ISNULL(@NewForeheadVisitTime, ForeheadVisitTime),
            NumberGuest = ISNULL(@NewNumberGuest, NumberGuest),
            TotalPrice = ISNULL(@TotalPrice, TotalPrice)
        WHERE ReservationID = @ReservationID;
    END TRY
    BEGIN CATCH
        -- Handle errors if needed
        PRINT 'Error occurred while updating reservation.';
    END CATCH;

    -- Display the updated reservation record
    SELECT * FROM Reservation WHERE ReservationID = @ReservationID;
END;